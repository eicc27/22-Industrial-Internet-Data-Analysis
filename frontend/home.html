<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- 1. 引入vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- 2. 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
    <!-- 3. 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>数据分析</title>
    <style>
        body,
        html,
        #app {
            margin: 0 0;
            height: 100%;
        }

        .el-container {
            margin: 0 auto;
            height: 100%;
            width: 100%;
        }

        .el-header,
        .el-footer {
            margin: 0 auto;
            width: 100%;

            text-align: center;
        }

        .el-main {
            margin: 0 auto;
            width: 100%;
            padding: 2px 2px;
        }

        .block {
            margin: auto auto;
            width: 60%;
            height: 93%;
            padding: 20px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 6px rgba(0, 0, 0, 0.08);
        }

        .el-row {
            margin-bottom: 20px;
        }

        .el-form-item {
            margin-bottom: 0px;
        }

        .el-form-item__content {
            display: flex;
        }

        .el-input {
            width: auto;
        }
    </style>
</head>

<body>
    <div id="app">
        <el-container>
            <el-header style="background-color: rgba(0, 204, 255, 0.15);">
                <h1>数据分析和预测</h1>
            </el-header>
            <el-main>
                <!-- 0.欢迎界面 -->
                <div class="block" v-if="visibleStep[0].visible" style="border-radius:0;box-shadow:0 0 0 ">
                    <el-row type="flex" justify="center">
                        welcome
                    </el-row>
                    <el-row type="flex" justify="center">
                        <el-button type="primary" round v-on:click="turnToNextStep(0)">开始</el-button>
                    </el-row>
                </div>
                <!-- 0.欢迎界面end -->
                <!-- 1.训练数据上传 -->
                <div class="block" v-if="visibleStep[1].visible">
                    <el-container>
                        <el-header>
                            1、上传训练数据集并预处理
                        </el-header>
                        <el-main>
                            <el-col :span="span_1">
                                <el-row type="flex" justify="center">
                                    <el-upload class="upload-demo" drag action="http://127.0.0.1:12000/upload"
                                        ref="uploadPrep" accept=".csv" :action="uploadUrl" :before-upload="beforeUpload"
                                        name="preproc.csv" :on-remove="preRemove" :on-success="handleUploadPreSuccess"
                                        :limit="1">
                                        <i class="el-icon-upload" style="font-size: 45px;">预处理数据</i>
                                        <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                                    </el-upload>
                                </el-row>
                            </el-col>
                            <el-col :span="span_2">
                                <div v-if="op_vis">
                                    <el-form ref="preprocForm" :model="preprocForm">
                                        <el-row :gutter="2">
                                            <el-col :span="14">
                                                <el-form-item label="sifting method">
                                                    <el-select v-model="preprocForm.sifting.method" @change="siftChange"
                                                        clearable>
                                                        <el-option v-for="method in sifting" :key="method"
                                                            :label="method" :value="method">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="8">
                                                <el-form-item label="th">
                                                    <el-select v-model="preprocForm.sifting.th" @change="siftthChange"
                                                        clearable :disabled="sift_th_dis">
                                                        <el-option v-for="th in sifting_th" :key="th" :label="th"
                                                            :value="th">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>
                                        <el-row :gutter="2">
                                            <el-col :span="11">
                                                <el-form-item label="运算列">
                                                    <el-select v-model="preprocForm.data_col" collapse-tags multiple
                                                        placeholder="选择参与运算的数据" @change="opChange">
                                                        <el-option v-for="(col,index) in options_col" :key="index"
                                                            :label="col" :value="index">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="11">
                                                <el-form-item label="预测列">
                                                    <el-select v-model="preprocForm.pred_col" :disabled="pred_col_dis">
                                                        <el-option v-for="(col,index) in options_pred" :key="index"
                                                            :label="col" :value="index">
                                                        </el-option>
                                                    </el-select>
                                                </el-form-item>
                                            </el-col>
                                        </el-row>
                                        <el-row>
                                            <el-form-item v-for="(col,index) in preprocForm.data_col"
                                                :label="options_col[col]" :key="col">
                                                <el-row :gutter="2">
                                                    <el-col :span="11">
                                                        <el-select v-model="preprocForm.dir_p_n[col][0]" clearable
                                                            @change="$forceUpdate()" placeholder="padding">
                                                            <el-option v-for="item in padding" :key="item" :label="item"
                                                                :value="item">
                                                            </el-option>
                                                        </el-select>
                                                    </el-col>
                                                    <el-col :span="11">
                                                        <el-select v-model="preprocForm.dir_p_n[col][1]" clearable
                                                            @change="$forceUpdate()" placeholder="norm">
                                                            <el-option v-for="item in norm" :key="item" :label="item"
                                                                :value="item">
                                                            </el-option>
                                                        </el-select>
                                                    </el-col>
                                                </el-row>
                                            </el-form-item>
                                        </el-row>
                                    </el-form>
                                </div>
                            </el-col>
                        </el-main>
                        <el-footer>
                            <el-row type="flex" justify="center">
                                <el-button type="primary" round v-on:click="turnToPrevStep(1)">上一步</el-button>
                                <el-button type="primary" round v-on:click="uploadPreForm">上传</el-button>
                                <el-button type="primary" round
                                    v-on:click="clearPreCols();turnToNextStep(1);algorithm_get();">下一步</el-button>
                            </el-row>
                        </el-footer>
                    </el-container>
                </div>
                <!-- 1.训练数据上传end -->
                <!-- 2.算法选择 -->
                <div class="block" v-if="visibleStep[2].visible">
                    <el-container>
                        <el-header>
                            2、选择训练算法
                        </el-header>
                        <el-main>
                            <el-col :span="12">
                                <el-form ref="algorithmForm" :model="algorithmForm" label-width="110px">
                                    <el-form-item label="训练算法">
                                        <el-select v-model="algorithmForm.algorithm" placeholder="请选择"
                                            @change="resetAlForm">
                                            <el-option v-for="item in options_alg" :key="item.value" :label="item.label"
                                                :value="item.value">
                                                <el-popover placement="left-start" :title="item.label" width="350"
                                                    trigger="hover" :content="item.description">
                                                    <p> {{item.description}} </p>
                                                    <img :src="item.image" width="300" />
                                                    <el-button slot="reference" type="text"
                                                        style="width:100%;color:black;">
                                                        <span>{{item.label}}</span>
                                                    </el-button>
                                                </el-popover>
                                            </el-option>
                                        </el-select>
                                    </el-form-item>
                                    <div v-if="algorithmForm.algorithm == 'linearRegression'">
                                        <el-form-item label="损失函数">
                                            <el-select v-model="algorithmForm.loss">
                                                <el-option v-for="item in loss" :key="item" :label="item" :value="item">
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item label="最大迭代次数">
                                            <el-input v-model="algorithmForm.max_iter_li">
                                            </el-input>
                                        </el-form-item>
                                        <el-form-item label="停止的误差标准">
                                            <el-input v-model="algorithmForm.tol">
                                            </el-input>
                                        </el-form-item>
                                        <el-form-item label="是否打乱次序">
                                            <div><!-- 用个div将Switch撑起来-->
                                                <el-switch v-model="algorithmForm.shuffle" active-text="是"
                                                    inactive-text="否">
                                                </el-switch>
                                            </div>
                                        </el-form-item>
                                    </div>
                                    <div v-if="algorithmForm.algorithm == 'decisionTreeClassfier'">
                                        <el-form-item label="分裂选择评估">
                                            <el-select v-model="algorithmForm.criterion">
                                                <el-option v-for="item in criterion" :key="item" :label="item"
                                                    :value="item">
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item label="最大深度">
                                            <el-input v-model="algorithmForm.max_depth">
                                            </el-input>
                                        </el-form-item>
                                        <el-form-item label="最大叶节点数量">
                                            <el-input v-model="algorithmForm.max_leaf_nodes">
                                            </el-input>
                                        </el-form-item>
                                    </div>
                                    <div v-if="algorithmForm.algorithm == 'SVMClassifier'">
                                        <el-form-item label="核函数">
                                            <el-select v-model="algorithmForm.kernel">
                                                <el-option v-for="item in kernel" :key="item" :label="item"
                                                    :value="item">
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item label="正则化参数">
                                            <el-input v-model="algorithmForm.C">
                                            </el-input>
                                        </el-form-item>
                                        <el-form-item label="最大迭代次数">
                                            <el-input v-model="algorithmForm.max_iter_svm">
                                            </el-input>
                                        </el-form-item>
                                        <el-form-item label="停止的误差标准">
                                            <el-input v-model="algorithmForm.tol">
                                            </el-input>
                                        </el-form-item>

                                    </div>
                                    <div v-if="algorithmForm.algorithm != ''">
                                        <el-row></el-row>
                                        <el-row type="flex" justify="center">
                                            <el-button type="primary" round v-on:click="resetAlForm">重置为默认值</el-button>
                                        </el-row>
                                    </div>

                                </el-form>
                            </el-col>
                            <el-col :span="12">
                                <el-row type="flex" justify="center">
                                    <el-upload class="upload-demo" drag
                                        action="https://jsonplaceholder.typicode.com/posts/" ref="uploadTrain"
                                        accept=".csv" :auto-upload="false" :action="uploadUrl"
                                        :before-upload="beforeUpload" name="train.csv" :on-remove="clearPreCols"
                                        :on-success="handleUploadTrainSuccess" :limit="1">
                                        <i class="el-icon-upload" style="font-size: 45px;">训练数据</i>
                                        <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                                    </el-upload>
                                </el-row>
                                <el-row type="flex" justify="center">
                                    <el-upload class="upload-demo" drag
                                        action="https://jsonplaceholder.typicode.com/posts/" ref="uploadTest"
                                        accept=".csv" :auto-upload="false" :action="uploadUrl"
                                        :before-upload="beforeUpload" name="test.csv" :on-remove="clearPreCols"
                                        :on-success="handleUploadTestSuccess" :limit="1">
                                        <i class="el-icon-upload" style="font-size: 45px;">测试数据</i>
                                        <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                                    </el-upload>
                                </el-row>
                            </el-col>

                        </el-main>
                        <el-footer>
                            <el-row type="flex" justify="center">
                                <el-button type="primary" round v-on:click="turnToPrevStep(2)">上一步</el-button>
                                <el-button type="primary" round
                                    v-on:click="turnToNextStep(2);wait_train()">开始训练</el-button>
                            </el-row>
                        </el-footer>
                    </el-container>
                </div>
                <!-- 2.算法选择end -->
                <!-- 3.输出模型-->
                <div class="block" v-if="visibleStep[3].visible">
                    <el-row>3、获得分析模型</el-row>
                    <el-row type="flex" justify="center">
                        <el-button type="primary" round v-on:click="download">点击下载模型</el-button>
                        <el-button type="primary" round v-on:click="turnToNextStep(3)">以此模型进行数据预测</el-button>
                    </el-row>
                    <el-row type="flex" justify="center">
                        <el-button type="primary" round v-on:click="turnToPrevStep(3)">上一步</el-button>
                        <el-button type="danger" round v-on:click="turnToStep0(3)">首页</el-button>
                    </el-row>
                </div>
                <!-- 3.输出模型end-->
                <!-- 4.上传预测文件-->
                <div class="block" v-if="visibleStep[4].visible">
                    <el-row>4、上传预测文件</el-row>
                    <el-row>
                        <el-upload class="upload-demo" drag action="https://jsonplaceholder.typicode.com/posts/"
                            ref="uploadPredModel" accept=".model" :action="uploadUrl" :before-upload="beforeUploadModel"
                            name="predict.csv" :auto-upload="false" :on-success="handleUploadPredSuccess" :limit="1">
                            <i class="el-icon-upload" style="font-size: 45px;">预测模型</i>
                            <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                        </el-upload>
                        <el-upload class="upload-demo" drag action="https://jsonplaceholder.typicode.com/posts/"
                            ref="uploadPredCSV" accept=".csv" :action="uploadUrl" :before-upload="beforeUpload"
                            name="predict.model" :auto-upload="false" :on-success="handleUploadDataSuccess" :limit="1">
                            <i class="el-icon-upload" style="font-size: 45px;">预测数据</i>
                            <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                        </el-upload>
                        <el-row type="flex" justify="center">
                            <el-button type="primary" round v-on:click="upload">确认上传</el-button>
                        </el-row>
                    </el-row>
                    <el-row type="flex" justify="center">
                        <el-button type="primary" round v-on:click="turnToPrevStep(4)">上一步</el-button>
                        <el-button type="primary" round v-on:click="turnToNextStep(4);predict()">进行预测</el-button>
                        <el-button type="danger" round v-on:click="turnToStep0(4)">首页</el-button>
                    </el-row>
                </div>
                <!-- 4.上传预测文件end-->
                <!-- 5.预测结果及下载-->
                <div class="block" v-if="visibleStep[5].visible">
                    <el-row>5、预测结果及下载</el-row>
                    <el-row type="flex" justify="center">
                        <el-button type="primary" round v-on:click="download">点击下载预测结果</el-button>
                        <el-button type="primary" round v-on:click="showChart">查看预测结果</el-button>
                    </el-row>
                    <el-row type="flex" justify="center">
                        <el-button type="primary" round v-on:click="turnToPrevStep(5)">上一步</el-button>
                        <el-button type="danger" round v-on:click="turnToStep0(5)">首页</el-button>
                    </el-row>
                </div>
                <!-- 5.预测结果及下载end-->
            </el-main>
            <el-footer style="background-color: rgba(0, 204, 255, 0.15);">
                <h3></h3>
            </el-footer>
        </el-container>
    </div>
</body>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                fileList: [],
                //进行到哪一步，哪一步可见
                visibleStep: [
                    { visible: true, lable: 'step0' },
                    { visible: false, lable: 'step1' },
                    { visible: false, lable: 'step2' },
                    { visible: false, lable: 'step3' },
                    { visible: false, lable: 'step4' },
                    { visible: false, lable: 'step5' },
                ],
                //预处理算法
                padding: ['zero', 'mean', 'median', 'knnc', 'knnr', 'forestc', 'forestr'],
                norm: ['minmax', 'zscore', 'sigmoid', 'log', 'l2'],
                sifting: ['dbscan', 'if'],
                sifting_th: ['float'],
                //预测时选择参与运算的列和需要预测的列
                span_1: 24,
                span_2: 0,
                options_col: [],
                options_pred: [],
                op_vis: false,
                pred_col_dis: true,
                sift_th_dis: true,
                //预处理表单
                preprocForm: {
                    data_col: [],
                    pred_col: '',
                    padding: [],
                    norm: [],
                    dir_p_n: {},
                    sifting: {
                        method: '',
                        th: null,
                    },
                },
                //算法选择
                options_alg: [{
                    value: 'linearRegression',
                    label: 'linearRegression',
                    description: 'linearRegression算法是...(可能会有图,要预留空间,图片是测试用的)',
                    score: 5,
                    image: 'https://cube.elemecdn.com/6/94/4d3ea53c084bad6931a56d5158a48jpeg.jpeg'
                }, {
                    value: 'decisionTreeClassfier',
                    label: 'decisionTreeClassfier',
                    description: 'decisionTreeClassfier算法是...',
                    score: 4,
                    image: 'https://cube.elemecdn.com/6/94/4d3ea53c084bad6931a56d5158a48jpeg.jpeg'
                }, {
                    value: 'SVMClassifier',
                    label: 'SVMClassifier',
                    description: 'SVMClassifier算法是...',
                    score: 4,
                    image: 'https://cube.elemecdn.com/6/94/4d3ea53c084bad6931a56d5158a48jpeg.jpeg'
                },
                ],
                //算法参数选择
                loss: ["squared_loss", "huber", "epsilon_insensitive", "squared_epsilon_insensitive"],
                criterion: ["gini", "entropy", "log_loss"],
                kernel: ["linear", "poly", "rbf", "sigmoid", "precomputed"],
                algorithmForm: {
                    algorithm: '',
                    //linearRegression
                    loss: "squared_loss",
                    max_iter_li: 1000,
                    shuffle: true,
                    tol: 0.001,
                    //decisionTreeClassfier
                    criterion: "gini",
                    max_depth: 1000,
                    max_leaf_nodes: 1000,
                    //SVMClassifier
                    C: 1.0,
                    kernel: "rbf",
                    //注：svm也有tol，由于默认值相同，不保存为两个
                    max_iter_svm: -1,
                    //注：max_iter重名，表单获取完后再赋值
                    max_iter: '',
                },
            };
        },
        methods: {
            handleUploadPreSuccess(res, file, fileList) {
                this.$message.success('csv文件上传成功!');

                let reader = new FileReader();   //先new 一个读文件的对象 FileReader
                if (typeof FileReader === "undefined") {  //用来判断你的浏览器是否支持 FileReader
                    this.$message.error('浏览器不支持文件读取');
                    return;
                }
                reader.readAsText(file.raw);
                reader.onload = (e) => {
                    let isSame = (e.target.result.split('\n')[0].replace('\r', '') === this.options_col.join(','))
                    if (!isSame) {
                        this.$message.warning("读取新数据列")
                        this.clearPreCols();
                        this.getCols(file, fileList);
                    } else {
                        this.$message.success("数据列相同，保留初始选择")
                        this.op_vis = true;
                        this.span_1 = 12;
                        this.span_2 = 12;
                    }
                }
            },
            preRemove() {
                this.op_vis = false;
                this.span_1 = 24;
                this.span_2 = 0;
            },
            beforeUpload(file) {
                console.log('type', file.type)
                const isCSV = (file.type === "application/vnd.ms-excel")
                    || (file.type === "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
                    || (file.type === "text/csv");
                if (!isCSV) {
                    this.$message.error('上传文件只能是 csv 格式!');
                }
                return isCSV;
            },
            beforeUploadModel(file) {
                return true;
            },
            getCols(file, fileList) {
                let reader = new FileReader();   //先new 一个读文件的对象 FileReader
                if (typeof FileReader === "undefined") {  //用来判断你的浏览器是否支持 FileReader
                    this.$message.error('浏览器不支持文件读取');
                    return;
                }
                reader.readAsText(file.raw);
                reader.onload = (e) => {
                    this.options_col = e.target.result.split('\n')[0].replace('\r', '').split(',');
                    this.op_vis = true;
                    this.span_1 = 12;
                    this.span_2 = 12;
                    this.pred_col_dis = false;
                    for (let i = 0; i < this.options_col.length; i++) {
                        if (i < this.options_col.length - 1) {
                            this.preprocForm.data_col.push(i);
                        } else {
                            this.preprocForm.pred_col = i;
                        }
                        this.preprocForm.dir_p_n[i] = [null, null];
                    }
                }
            },
            clearPreCols() {
                this.op_vis = false;
                this.span_1 = 24;
                this.span_2 = 0;
                this.options_pred = [];
                this.pred_col_dis = true;
                this.sift_th_dis = true;
                this.preprocForm = {
                    data_col: [],
                    pred_col: '',
                    padding: [],
                    norm: [],
                    dir_p_n: {},
                    sifting: {
                        method: '',
                        th: null,
                    },
                };
            },
            opChange() {
                this.preprocForm.data_col.sort((a, b) => { return a - b });
                this.options_pred = [];
                this.preprocForm.pred_col = '';
                this.pred_col_dis = true;
                if (!(this.preprocForm.data_col == undefined || this.preprocForm.data_col.length <= 0)) {
                    for (let i = 0; i < this.options_col.length; i++) {
                        if (!this.preprocForm.data_col.includes(i)) {
                            this.options_pred.push(this.options_col[i]);
                            if (this.preprocForm.dir_p_n[i][0] !== null) {
                                this.preprocForm.dir_p_n[i][0] = null;
                            }
                            if (this.preprocForm.dir_p_n[i][1] !== null) {
                                this.preprocForm.dir_p_n[i][1] = null;
                            }
                        }
                    }
                    if (this.options_pred.length <= 0) {
                        this.pred_col_dis = true;
                    } else {
                        this.pred_col_dis = false;
                    }
                }
            },
            siftChange() {
                if (this.preprocForm.sifting.method == "dbscan") {
                    this.preprocForm.sifting.th = 'float';
                    this.sift_th_dis = true;
                } else if (this.preprocForm.sifting.method == "if") {
                    this.preprocForm.sifting.th = '';
                    this.sift_th_dis = false;
                } else {
                    this.preprocForm.sifting.th = '';
                    this.sift_th_dis = true;
                }
            },
            siftthChange() {
                console.log("th", this.preprocForm.sifting.th);
            },
            uploadPreForm() {
                //todo 上传preprocForm
                for (let i in this.preprocForm.dir_p_n) {
                    this.preprocForm.padding.push(this.preprocForm.dir_p_n[i][0])
                    this.preprocForm.norm.push(this.preprocForm.dir_p_n[i][1])
                }
                axios.post(
                    'http://127.0.0.1:12000/preproc', this.preprocForm
                ).then(
                    (res) => {
                        console.log(res)
                    }, (error) => {
                        console.log(error)
                    })
                //if success 保存csv
                //else
            },
            clearAll() {
                this.clearPreCols();
            },
            resetAlForm() {
                this.algorithmForm.loss = "squared_loss"
                this.algorithmForm.max_iter_li = 1000
                this.algorithmForm.shuffle = true
                this.algorithmForm.tol = 0.001
                this.algorithmForm.criterion = "gini"
                this.algorithmForm.max_depth = 1000
                this.algorithmForm.max_leaf_nodes = 1000
                this.algorithmForm.C = 1.0
                this.algorithmForm.kernel = "rbf"
                this.algorithmForm.max_iter_svm = -1
            },
            handleUploadTrainSuccess() {
                //todo
            },
            handleUploadTestSuccess() {
                //todo
            },
            handleUploadModelSuccess() {
                //todo
            }, 
            handleUploadTestSuccess() {
                //todo
            },
            turnToPrevStep(step) {
                this.visibleStep[step - 1].visible = true;
                this.visibleStep[step].visible = false;
                console.log(this.preprocForm);
                this.clearAll();
            },
            turnToNextStep(step) {
                this.visibleStep[step + 1].visible = true;
                this.visibleStep[step].visible = false;
                this.clearAll();
            },
            turnToStep0(step) {
                this.visibleStep[0].visible = true;
                this.visibleStep[step].visible = false;
                this.clearAll();
            },
            wait_train() {
                //TODO
                alert('training...');
            },
            download() {
                //TODO
                alert('downloading...(要用户指定下载地址)');
            },
            predict() {
                //TODO
                alert('predicting...');
            },
            algorithm_get() {
                //TODO
                alert('algorithm_getting...');
            },
            showChart() {
                //TODO
                alert('chart TODO');
            }

        },
        created() {
            //上传文件地址
            this.uploadUrl = "https://930d4a54-3745-4938-8384-c8570928a27b.mock.pstmn.io/upload";
        }
    });
</script>

</html>